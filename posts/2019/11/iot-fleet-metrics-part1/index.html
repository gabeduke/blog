<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Gabriel Duke"><meta name=description content="TL/DR This guide documents a simple Prometheus PushGateway setup on top of Civo's k3s offering. We will then push some data to the gateway and visualize it in Grafana.
The end result for this project is an environmental monitoring system that gathers sensor data. I won't actually deploy the scrape jobs in this guide, but we will send a metric with curl and visualize it in each of the core components."><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://gabeduke.github.io/weblog/posts/2019/11/iot-fleet-metrics-part1/><title>IOT Fleet Metrics (Part1) :: Adventures in over-engineering â€” IOT Sensor Fleet</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://gabeduke.github.io/weblog/main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><meta itemprop=name content="IOT Fleet Metrics (Part1)"><meta itemprop=description content="TL/DR This guide documents a simple Prometheus PushGateway setup on top of Civo's k3s offering. We will then push some data to the gateway and visualize it in Grafana.
The end result for this project is an environmental monitoring system that gathers sensor data. I won't actually deploy the scrape jobs in this guide, but we will send a metric with curl and visualize it in each of the core components."><meta itemprop=datePublished content="2019-11-19T09:30:04-05:00"><meta itemprop=dateModified content="2019-11-19T09:30:04-05:00"><meta itemprop=wordCount content="1126"><meta itemprop=image content="https://gabeduke.github.io/weblog"><meta itemprop=keywords content="civo,iot,openfaas,kubernetes,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gabeduke.github.io/weblog"><meta name=twitter:title content="IOT Fleet Metrics (Part1)"><meta name=twitter:description content="TL/DR This guide documents a simple Prometheus PushGateway setup on top of Civo's k3s offering. We will then push some data to the gateway and visualize it in Grafana.
The end result for this project is an environmental monitoring system that gathers sensor data. I won't actually deploy the scrape jobs in this guide, but we will send a metric with curl and visualize it in each of the core components."><meta property="article:published_time" content="2019-11-19 09:30:04 -0500 -0500"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=https://gabeduke.github.io/weblog/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd $HOME</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://gabeduke.github.io/weblog/about/>About</a></li><li><a href=https://gabeduke.github.io/weblog/posts/>Posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>6 minutes</p></div><article><h1 class=post-title><a href=https://gabeduke.github.io/weblog/posts/2019/11/iot-fleet-metrics-part1/>IOT Fleet Metrics (Part1)</a></h1><div class=post-content><h2 id=tldr>TL/DR</h2><p>This guide documents a simple Prometheus PushGateway setup on top of <a href=https://www.civo.com/kube100>Civo's k3s</a> offering. We will then push some data to the gateway and visualize it in Grafana.</p><p>The end result for this project is an environmental monitoring system that gathers sensor data. I won't actually deploy the scrape jobs in this guide, but we will send a metric with curl and visualize it in each of the core components. The subsequent blogs will document building a native kubernetes operator to manage the sensor inputs.</p><p><img src=https://gabeduke.github.io/weblog/project.png alt="Civo IOT Design"></p><h2 id=table-of-contents>Table of Contents</h2><ul><li><a href=#tldr>TL/DR</a></li><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#summary>Summary</a></li><li><a href=#pre-requisites>Pre-requisites</a><ul><li><a href=#tools>Tools</a></li><li><a href=#setup>Setup</a></li></ul></li><li><a href=#provision-cluster>Provision Cluster</a></li><li><a href=#deploy-core-applications>Deploy Core Applications</a><ul><li><a href=#install-grafana>Install Grafana</a></li><li><a href=#install-prometheus>Install Prometheus</a></li><li><a href=#install-push-gateway>Install Push-Gateway</a></li></ul></li><li><a href=#visualize-data>Visualize data</a><ul><li><a href=#visualize-in-pushgateway>Visualize in PushGateway</a></li><li><a href=#visualize-in-prometheus>Visualize in Prometheus</a></li><li><a href=#visualize-in-grafana>Visualize in Grafana</a></li></ul></li><li><a href=#wrapping-up>Wrapping up</a></li></ul><h2 id=summary>Summary</h2><p>Prometheus PushGateway is a very useful tool to visualize batch metrics. This guide will walk through setting up a pushgateway instance and logging metrics from a simple BASH script. This is a great way to quickly visualize data <em>external</em> to kubernetes in a dead simple, sysadmin friendly way. The actual purpose of this project is to pull IOT sensor data into Prometheus, but I have tried to keep things as generic as possible in this first guide. In the next post I will begin building out the data logging functions into a kubernetes native operator.</p><p>The stack is deployed to <a href=https://www.civo.com/>Civo</a> cloud which runs a slimmed down flavor of kubernetes, called <a href=https://github.com/rancher/k3s>k3s</a>.</p><p>Components:</p><ul><li>K3s Cluster installed through Civo Cloud</li><li>Prometheus Operator (installed alongside the cluster via Civo marketplace)</li><li>PushGateway (installed via Helm)</li><li>Grafana (installed via Helm)</li></ul><h2 id=pre-requisites>Pre-requisites</h2><h3 id=tools>Tools</h3><table><thead><tr><th>Tool</th><th>Version</th></tr></thead><tbody><tr><td><a href=https://github.com/civo/cli#set-up>Civo-CLI</a></td><td>v0.5.1</td></tr><tr><td><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>Kubectl</a></td><td>v1.16.3</td></tr></tbody></table><p><strong>Notes</strong>:</p><ul><li><a href=https://kustomize.io/>Kustomize</a>: is part of the kubectl binary since v1.15. Generally helm is used for doing the heavy lifting creating an application, and kustomize steps in for the lighter pieces that require last minute transforms.</li><li>K3s ships with a helm operator that takes a CRD which can be applied with <code>kubectl</code>. This guide will deploy grafana and pushgateway using this method. More information can be found <a href=https://rancher.com/docs/k3s/latest/en/configuration/#auto-deploying-manifests>here</a></li></ul><h3 id=setup>Setup</h3><p>Before getting started let's export some variables so they will be available throughout this guide. We also want to update our helm repo with the latest charts:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export CLUSTER_NAME<span style=color:#f92672>=</span>civo-iot-<span style=color:#66d9ef>$(</span>whoami<span style=color:#66d9ef>)</span>
export NAMESPACE<span style=color:#f92672>=</span>default
</code></pre></div><h2 id=provision-cluster>Provision Cluster</h2><p>The first step is to provision a K3s cluster using the <a href=https://www.civo.com/learn/kubernetes-cluster-administration-using-civo-cli>Civo CLI</a>.</p><p>This will take a couple minutes, once finished the <code>--save</code> flag wil point your kubectl context to the new cluster.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>civo kubernetes create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --applications prometheus-operator <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --nodes <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --save --switch --wait <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>
</code></pre></div><p>We are initializing the cluster with the <code>prometheus-operator</code> application from the <a href=https://github.com/civo/kubernetes-marketplace>Civo Marketplace</a>. Once the cluster has finished booting you can explore the default cluster monitors, provisioned by the prometheus operator. First port-forward to the grafana instance: <code>kubectl port-forward svc/prometheus-operator-grafana 8080:80 --namespace monitoring</code> and navigate to <code>http://localhost:8080</code> . You can log in with the username <code>admin</code> and the password <code>prom-operator</code>. Not every dashboard will work since the k3s distribution has a slightly different topology then a vanilla kubernetes cluster.</p><p>In the next steps we will provision our own instances of Prometheus and Grafana.</p><h2 id=deploy-core-applications>Deploy Core Applications</h2><p>The stack consists of a few core applications, and jobs to fetch the data.</p><ul><li><strong>Grafana</strong>: is a powerful visualization tool we will use for displaying our metrics. This could be considered the &lsquo;frontend&rsquo; of our application.</li><li><strong>Prometheus</strong>: is a time-series database that scales incredibly well. This is our &lsquo;backend&rsquo;. Prometheus is generally configured to scrape metrics data from applications on regular intervals.</li><li><strong>PushGateway</strong>: is a &lsquo;sink&rsquo; or &lsquo;buffer&rsquo; for metric data that is too short lived for Prometheus to scrape. This is what our cron jobs will log data to since the containers wont live long enough for Prometheus to ever see them.</li></ul><h3 id=install-grafana>Install Grafana</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>
<span style=color:#75715e># deploy/charts/grafana.yaml</span>
#
cat <span style=color:#e6db74>&lt;&lt;EOF &gt; /tmp/grafana.yaml
</span><span style=color:#e6db74>apiVersion: helm.cattle.io/v1
</span><span style=color:#e6db74>kind: HelmChart
</span><span style=color:#e6db74>metadata:
</span><span style=color:#e6db74>  name: grafana
</span><span style=color:#e6db74>  namespace: kube-system
</span><span style=color:#e6db74>spec:
</span><span style=color:#e6db74>  chart: stable/grafana
</span><span style=color:#e6db74>  version: 4.0.4
</span><span style=color:#e6db74>  targetNamespace: default
</span><span style=color:#e6db74>  valuesContent: |-
</span><span style=color:#e6db74>    datasources:
</span><span style=color:#e6db74>      datasources.yaml:
</span><span style=color:#e6db74>        apiVersion: 1
</span><span style=color:#e6db74>        datasources:
</span><span style=color:#e6db74>        - name: Prometheus
</span><span style=color:#e6db74>          type: prometheus
</span><span style=color:#e6db74>          url: http://prometheus-operated:9090
</span><span style=color:#e6db74>          access: proxy
</span><span style=color:#e6db74>          isDefault: true
</span><span style=color:#e6db74>EOF</span>

<span style=color:#75715e># Apply the chart</span>
kubectl apply -f /tmp/grafana.yaml
</code></pre></div><h3 id=install-prometheus>Install Prometheus</h3><p>When we provisioned the cluster we installed the prometheus operator which installs an instance of prometheus by default. This instance is used for monitoring the cluster so we generally want to avoid using it for application data. Luckily operators make it super easy to spawn new instances. We simply need to create a Prometheus CRD and attach some RBAC permissions.</p><p>This is what the directory tree looks like:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>deploy/manifest/prometheus
â”œâ”€â”€ kustomization.yaml
â”œâ”€â”€ prometheus-rolebinding.yaml
â”œâ”€â”€ prometheus-role.yaml
â”œâ”€â”€ prometheus-sa.yaml
â””â”€â”€ prometheus.yaml
</code></pre></div><p>To install we can build the directory with <code>kustomize</code> and pipe it directly to the cluster:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>TARGET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;github.com/gabeduke/civo-iot/deploy/manifest/prometheus/?ref=1.0.0&#34;</span>

<span style=color:#75715e># # If you have the repository checked out then you can uncomment the following line</span>
<span style=color:#75715e># TARGET=deploy/manifest/prometheus</span>

kubectl kustomize <span style=color:#e6db74>${</span>TARGET<span style=color:#e6db74>}</span> | kubectl apply -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> -f -

</code></pre></div><h3 id=install-push-gateway>Install Push-Gateway</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>
<span style=color:#75715e># deploy/charts/pushgateway.yaml</span>
#
cat <span style=color:#e6db74>&lt;&lt;EOF &gt; /tmp/pushgateway.yaml
</span><span style=color:#e6db74>apiVersion: helm.cattle.io/v1
</span><span style=color:#e6db74>kind: HelmChart
</span><span style=color:#e6db74>metadata:
</span><span style=color:#e6db74>  name: metrics-sink
</span><span style=color:#e6db74>  namespace: kube-system
</span><span style=color:#e6db74>spec:
</span><span style=color:#e6db74>  chart: stable/prometheus-pushgateway
</span><span style=color:#e6db74>  version: 1.2.5
</span><span style=color:#e6db74>  targetNamespace: default
</span><span style=color:#e6db74>  set:
</span><span style=color:#e6db74>    metrics.enabled: &#34;true&#34;
</span><span style=color:#e6db74>    serviceMonitor.enabled: &#34;true&#34;
</span><span style=color:#e6db74>    serviceMonitor.namespace: &#34;default&#34;
</span><span style=color:#e6db74>EOF</span>

<span style=color:#75715e># Apply the chart</span>
kubectl apply -f /tmp/pushgateway.yaml
</code></pre></div><h2 id=visualize-data>Visualize data</h2><p>Lets validate that the services are all working by pushing a data point to PushGateway manually.</p><p>Wait until alll pods are running and then start the proxies:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>
<span style=color:#75715e># Proxy Grafana</span>
kubectl port-forward svc/grafana -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> 8080:80 &amp;

<span style=color:#75715e># Proxy Prometheus</span>
kubectl port-forward svc/prometheus-operated -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> 9090:9090 &amp;

<span style=color:#75715e># Proxy PushGateway</span>
kubectl port-forward svc/metrics-sink-prometheus-pushgateway -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> 9091:9091 &amp;
</code></pre></div><p>Once the proxies are active you can drop a metric onto the pushgateway:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo <span style=color:#e6db74>&#34;sample_metric 1&#34;</span> | curl --silent --data-binary @- <span style=color:#e6db74>&#34;http://localhost:9091/metrics/job/sanity-test&#34;</span>
</code></pre></div><h3 id=visualize-in-pushgateway>Visualize in PushGateway</h3><p>http://localhost:9091</p><p>Notice there is a new group for <code>sanity-test</code> and the data point <code>sample_metric</code> is equal to 1.</p><p><img src=https://gabeduke.github.io/weblog/pushgateway.png alt></p><p>To see the raw metrics that prometheus will scrape, navigate to http://localhost:9091/metrics and notice the new line:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># TYPE sample_metric untyped</span>
sample_metric<span style=color:#f92672>{</span>instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>,job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sanity-test&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>1</span>
</code></pre></div><h3 id=visualize-in-prometheus>Visualize in Prometheus</h3><p>http://localhost:9090</p><p>Prometheus is where the data will be aggregated and we can perform queries over time. Since we only have a single data point we will see a line in the graph when searching for <code>sample_metric</code>. As we build out the monitoring system we can add CRDs to generate alerts on our data.</p><p><img src=https://gabeduke.github.io/weblog/prometheus.png alt></p><h3 id=visualize-in-grafana>Visualize in Grafana</h3><p>Grafana is where we will compile dashboards to display Prometheus queries.</p><p>To get the password from the next step: <code>kubectl get secret --namespace default grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo</code></p><p>Log in with the username <code>admin</code> and password will be <code>${PASSWORD}</code>. Again the visualization is not very interesting with a single data point but this is a simple sanity test.</p><p>To validate our sample metric we are going to use the <em>Explore</em> function. Navigate to http://localhost:8080/explore</p><p><img src=https://gabeduke.github.io/weblog/grafana_explore.png alt></p><h2 id=wrapping-up>Wrapping up</h2><p>Congradulations! You now have the foundation for a batch metrics monitoring system! Keep an eye out for the next post where I will walk thorugh connecting real sensor data.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://gabeduke.github.io/weblog/tags/civo>civo</a></span><span class=tag><a href=https://gabeduke.github.io/weblog/tags/iot>iot</a></span><span class=tag><a href=https://gabeduke.github.io/weblog/tags/openfaas>openfaas</a></span><span class=tag><a href=https://gabeduke.github.io/weblog/tags/kubernetes>kubernetes</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1126 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2019-11-19 14:30 +0000</p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2020</span>
<span><a href=https://gabeduke.github.io/weblog>Gabriel Duke</a></span>
<span></span><span><a href=https://gabeduke.github.io/weblog/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=https://gabeduke.github.io/weblog/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>