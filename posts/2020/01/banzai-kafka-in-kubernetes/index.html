<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Gabriel Duke"><meta name=description content="This example deploys a Kafka cluster using Banzai Cloud Kafka Operator. This guide is a condensed version of the official Banzai documentation, the idea being to quickly get up and running with Kafka.
Setup Prerequisites:
 Civo CLI (Not strictly necessary but it is FAST) Helm3 Kubectl  Provision Kubernetes Any kubernetes cluster will do but for this tutorial I'll use Civo Cloud's offering.
civo k8s create \  --nodes 3 \  --save --switch --wait \  kafka Provision Dependencies Let's get the core dependencies provisioned."><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://gabeduke.github.io/weblog/posts/2020/01/banzai-kafka-in-kubernetes/><title>Banzai Kafka in Kubernetes :: Adventures in over-engineering — IOT Sensor Fleet</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://gabeduke.github.io/weblog/main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css><meta itemprop=name content="Banzai Kafka in Kubernetes"><meta itemprop=description content="This example deploys a Kafka cluster using Banzai Cloud Kafka Operator. This guide is a condensed version of the official Banzai documentation, the idea being to quickly get up and running with Kafka.
Setup Prerequisites:
 Civo CLI (Not strictly necessary but it is FAST) Helm3 Kubectl  Provision Kubernetes Any kubernetes cluster will do but for this tutorial I'll use Civo Cloud's offering.
civo k8s create \  --nodes 3 \  --save --switch --wait \  kafka Provision Dependencies Let's get the core dependencies provisioned."><meta itemprop=datePublished content="2020-01-09T09:30:08-05:00"><meta itemprop=dateModified content="2020-01-09T09:30:08-05:00"><meta itemprop=wordCount content="655"><meta itemprop=image content="https://gabeduke.github.io/weblog"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gabeduke.github.io/weblog"><meta name=twitter:title content="Banzai Kafka in Kubernetes"><meta name=twitter:description content="This example deploys a Kafka cluster using Banzai Cloud Kafka Operator. This guide is a condensed version of the official Banzai documentation, the idea being to quickly get up and running with Kafka.
Setup Prerequisites:
 Civo CLI (Not strictly necessary but it is FAST) Helm3 Kubectl  Provision Kubernetes Any kubernetes cluster will do but for this tutorial I'll use Civo Cloud's offering.
civo k8s create \  --nodes 3 \  --save --switch --wait \  kafka Provision Dependencies Let's get the core dependencies provisioned."><meta property="article:published_time" content="2020-01-09 09:30:08 -0500 -0500"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=https://gabeduke.github.io/weblog/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd $HOME</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://gabeduke.github.io/weblog/about/>About</a></li><li><a href=https://gabeduke.github.io/weblog/posts/>Posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 minutes</p></div><article><h1 class=post-title><a href=https://gabeduke.github.io/weblog/posts/2020/01/banzai-kafka-in-kubernetes/>Banzai Kafka in Kubernetes</a></h1><div class=post-content><p>This example deploys a Kafka cluster using <a href=https://github.com/banzaicloud/kafka-operator>Banzai Cloud Kafka Operator</a>. This guide is a condensed version of the official Banzai documentation, the idea being to quickly get up and running with Kafka.</p><h2 id=setup>Setup</h2><p><em>Prerequisites</em>:</p><ul><li><strong><a href=https://github.com/civo/cli>Civo CLI</a></strong> (Not strictly necessary but it is <em>FAST</em>)</li><li><strong><a href=https://helm.sh/docs/intro/install/>Helm3</a></strong></li><li><strong><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>Kubectl</a></strong></li></ul><h3 id=provision-kubernetes>Provision Kubernetes</h3><p>Any kubernetes cluster will do but for this tutorial I'll use <a href=https://www.civo.com/>Civo Cloud's</a> offering.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>civo k8s create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --nodes <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --save --switch --wait <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  kafka
</code></pre></div><h3 id=provision-dependencies>Provision Dependencies</h3><p>Let's get the core dependencies provisioned. We'll need:</p><ul><li><strong>Cert Manager</strong>: cert manager off loads the heavy lifting for certificate generation and rotation. There are many configurations that can be enabled, just check out the Banzai documentation for more information.</li><li><strong>Prometheus Operator</strong>: We only need the core bundle which will enable the use of <a href=https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/getting-started.md#related-resources>service monitors</a> and alerts. This is one of the key enablers that allows Banzai kafka clusters to recover and rebalance data.</li><li><strong>Zookeeper</strong>: You can use any zookeeper endpoint but Banzai has packaged an operator for use. Zookeeper is the key value database which stores the kafka state.</li></ul><p>We'll also need the <em>Banzai Helm Repo</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com/
</code></pre></div><p><em>Cert-Manager</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># create cert-manager deployment</span>
kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.11.0/cert-manager.yaml
</code></pre></div><p><em>Prometheus Operator</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># create the prometheus operator</span>
kubectl apply -n default -f https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml
</code></pre></div><p><em>Zookeeper Operator</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># create zookeeper namespace</span>
kubectl create namespace zookeeper

<span style=color:#75715e># create zk operator</span>
helm upgrade --install <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --namespace zookeeper <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --wait <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  zookeeper-operator banzaicloud-stable/zookeeper-operator
</code></pre></div><p><em>Zookeeper</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># create zookeeper cluster</span>
cat <span style=color:#e6db74>&lt;&lt;EOF | kubectl apply --namespace zookeeper -f -
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>apiVersion: zookeeper.pravega.io/v1beta1
</span><span style=color:#e6db74>kind: ZookeeperCluster
</span><span style=color:#e6db74>metadata:
</span><span style=color:#e6db74>  name: zookeepercluster
</span><span style=color:#e6db74>  namespace: zookeeper
</span><span style=color:#e6db74>spec:
</span><span style=color:#e6db74>  replicas: 3
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><h3 id=provision-banzai-kafka>Provision Banzai Kafka</h3><p>Again there are lots of configurations details this guide does not cover. Please see the <a href=https://github.com/banzaicloud/kafka-operator>Banzai documentation</a> for more options.</p><p>Components:</p><ul><li><strong>Kafka Operator</strong>: will maintain the lifecycle, data rebalancing and scaling for all the provisioned Kafkas in the cluster.</li><li><strong>Kafka Instance</strong>: this guide provisions a simple kafka instance, configured for internal cluster access and initialized with some basic scaling/rebalancing rules.</li></ul><p><em>Kafka Operator</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># create the kafka namespace</span>
kubectl create namespace kafka

<span style=color:#75715e># get the values file configured for prometheus</span>
TMP_FILE<span style=color:#f92672>=</span>/tmp/kafka-prometheus-alerts.yaml

curl https://raw.githubusercontent.com/gabeduke/civo-kafka-example/v1.0.0/kafka-prometheus-alerts.yaml -o $TMP_FILE -s

<span style=color:#75715e># install kafka operator with prometheus alerts</span>
helm upgrade --install <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --namespace kafka <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --values $TMP_FILE <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  kafka-operator banzaicloud-stable/kafka-operator
</code></pre></div><p><em>Kafka</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># create the kafka cluster</span>
KAFKA_INSTANCE<span style=color:#f92672>=</span>https://raw.githubusercontent.com/gabeduke/civo-kafka-example/v1.0.0/kafka.yaml
curl $KAFKA_INSTANCE | kubectl apply -n kafka -f -

<span style=color:#75715e># create the service monitor</span>

KAFKA_SERVICE_MONITOR<span style=color:#f92672>=</span>https://raw.githubusercontent.com/gabeduke/civo-kafka-example/v1.0.0/kafka-prometheus.yaml
curl $KAFKA_SERVICE_MONITOR | kubectl apply -n kafka -f -
</code></pre></div><h3 id=validate>Validate</h3><p>First we will validate the Cruise Control Dashboard is online and healthy. <a href=https://github.com/linkedin/cruise-control>Cruise Control</a> is a tool from LinkedIn which provides exceptional operational control over kafka clusters. The API can be triggered via Prometheus alerts, making Banzai clusters highly resilient. Go ahead and explore the configuration options.</p><p><em>Cruise Control Dashboard</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># proxy to the cruise-control dashboard for kafka maintenance (may take a couple minutes)</span>
kubectl port-forward -n kafka svc/kafka-cruisecontrol-svc 8090:8090 &amp;
echo http://localhost:8090
</code></pre></div><p>We can also validate that we can produce and consume from this cluster. First we need to provision a topic to use (<em>note</em>: the cluster must be finished provisioning before the topic can be applied):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># create a topic to which we can produce/consume</span>
cat <span style=color:#e6db74>&lt;&lt;EOF | kubectl apply -f -
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>apiVersion: kafka.banzaicloud.io/v1alpha1
</span><span style=color:#e6db74>kind: KafkaTopic
</span><span style=color:#e6db74>metadata:
</span><span style=color:#e6db74>  name: civo-topic
</span><span style=color:#e6db74>  namespace: kafka
</span><span style=color:#e6db74>spec:
</span><span style=color:#e6db74>  clusterRef:
</span><span style=color:#e6db74>    name: kafka
</span><span style=color:#e6db74>  name: civo-topic
</span><span style=color:#e6db74>  partitions: 3
</span><span style=color:#e6db74>  replicationFactor: 2
</span><span style=color:#e6db74>  config:
</span><span style=color:#e6db74>    &#34;retention.ms&#34;: &#34;604800000&#34;
</span><span style=color:#e6db74>    &#34;cleanup.policy&#34;: &#34;delete&#34;
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>Run the following two commands in separate terminals:</p><p><em>Produce</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># run a producer in a pod</span>
kubectl run kafka-producer <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -n kafka -it --rm<span style=color:#f92672>=</span>true --restart<span style=color:#f92672>=</span>Never <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --image<span style=color:#f92672>=</span>wurstmeister/kafka:2.12-2.3.0 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -- /opt/kafka/bin/kafka-console-producer.sh <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --broker-list kafka-headless:29092 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --topic civo-topic
</code></pre></div><p><em>Consume</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># run a consumer in a pod</span>
kubectl run kafka-consumer <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -n kafka -it --rm<span style=color:#f92672>=</span>true --restart<span style=color:#f92672>=</span>Never <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --image<span style=color:#f92672>=</span>wurstmeister/kafka:2.12-2.3.0 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -- /opt/kafka/bin/kafka-console-consumer.sh <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --bootstrap-server kafka-headless:29092 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --from-beginning <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --topic civo-topic
</code></pre></div><h2 id=clean>Clean</h2><p>Well that was fun. Go check out the Banzai docs and tune a cluster to your needs. Time to clean up!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># kill any dangling proxies</span>
killall kubectl

<span style=color:#75715e># clean up the kubernetes cluster</span>
civo k8s delete kafka
</code></pre></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>655 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-01-09 14:30 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://gabeduke.github.io/weblog/posts/2019/11/iot-fleet-metrics-part1/><span class=button__text>IOT Fleet Metrics (Part1)</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2020</span>
<span><a href=https://gabeduke.github.io/weblog>Gabriel Duke</a></span>
<span></span><span><a href=https://gabeduke.github.io/weblog/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=https://gabeduke.github.io/weblog/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script></body></html>